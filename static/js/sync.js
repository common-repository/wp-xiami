/** 
* @name WP-XiaMi
* @version 0.0.1
* @create 2014-05-01
* @lastmodified 2014-06-12 22:06
* @description WP-XiaMi Plugin
* @author MuFeng (http://mufeng.me)
* @url http://mufeng.me/wp-xiami.html
**/
(function($){var app=angular.module("WPXiaMiApp",["ngResource"]);app.factory("WPXiaMiAppHttp",["$http",function($http){return{get:function(uid,type,callback){$http({url:global.ajax_url,params:{action:"wpxiami",user_id:global.user_id,scope:global.user_type}}).success(function(data){callback.call(null,data)})}}}]);app.factory("WPXiaMiAppAlert",function($rootScope){var WPXiaMiAppAlert={};$rootScope.alerts=[];WPXiaMiAppAlert.add=function(type,msg){$rootScope.alerts.push({"type":type,"msg":msg,"close":function(){WPXiaMiAppAlert.closeAlert(this)}})};WPXiaMiAppAlert.closeAlert=function(alert){WPXiaMiAppAlert.closeAlertIdx($rootScope.alerts.indexOf(alert))};WPXiaMiAppAlert.closeAlertIdx=function(index){$rootScope.alerts.splice(index,1)};return WPXiaMiAppAlert});app.controller("WPXiaMiAppAlertContronller",["$scope","WPXiaMiAppAlert",function($scope,WPXiaMiAppAlert){$scope.alertUpdated=function(msg){WPXiaMiAppAlert.add("updated",msg)};$scope.alertError=function(msg){WPXiaMiAppAlert.add("error",msg)}}]);app.controller("WPXiaMiAppController",["$scope","WPXiaMiAppHttp","WPXiaMiAppAlert",function($scope,WPXiaMiAppHttp,WPXiaMiAppAlert){$scope.collects={uid:global.user_id,type:global.user_type,data:[],preview:{},selected:null};$scope.getjson=function(){if(!$scope.collects.uid||!$scope.collects.type){WPXiaMiAppAlert.add("error","uid not exist.")}else{WPXiaMiAppHttp.get($scope.collects.uid,$scope.collects.type,function(json){$scope.collects.data=json.msg})}};setTimeout(function(){$scope.getjson()},100)}]);app.filter("WPXiaMiFilter",function(){return function(data,type){if(type=="all"){return data}var result=[],i,len=data.length;for(i=0;i<len;i++){if(data[i].collect_type==type){result.push(data[i])}}return result}});app.directive("ngMenu",function(){return{restrict:"E",replace:"true",templateUrl:global.tmpl_url+"menu.html",link:function(scope,element,attrs){var _menu=["all","collects","albums"];scope.collects.menu=_menu;element.on("click",".theme-section",function(){var $self=$(this),_index=element.find(".theme-section").index($self),_type=_menu[_index];scope.$apply(function(){scope.collects.type=_type;scope.collects.selected=null});$(".wp-xiami-series.selected").removeClass("selected").removeAttr("style")})}}});app.directive("ngCollect",function(){return{restrict:"A",templateUrl:global.tmpl_url+"collect.html",link:function(scope,elem,attrs){elem.on("click",".wp-xiami-series",function(){var $self=$(this);if($self.hasClass("selected")){$self.removeClass("selected").removeAttr("style");scope.$apply(function(){scope.collects.selected=null})}else{var $series=$(".wp-xiami-series"),$preview=$("#wp-xiami-sync-preview"),_index=$series.index($self);$series.filter(".selected").removeAttr("style");scope.$apply(function(){scope.collects.selected=_index});var _height=$self.outerHeight(true)-19,__height=$preview.height()+50,_top=$self.offset().top;$self.addClass("selected").css({paddingBottom:__height});$(window).scrollTop(_top-40);$preview.css({top:_top+_height})}})}}});app.directive("ngPreview",function(){return{restrict:"A",templateUrl:global.tmpl_url+"preview.html",link:function(scope,elem,attrs){elem.on("click",".wp-xiami-preview-close",function(){$(".wp-xiami-series.selected").removeAttr("style");scope.$apply(function(){scope.collects.selected=null})})}}})})(jQuery);